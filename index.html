
<!DOCTYPE html>
<html lang="en" >

<head>
  <meta charset="UTF-8">
  
  
  

  <title>What are the Odds</title>

    <link rel="canonical" href="https://codepen.io/vpelss/pen/gOVqgeP">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  
  
  

  
  
  
</head>

<body>
  <!--
https://blog.demofox.org/2017/07/25/counting-bits-the-normal-distribution/
-->

<p>Also at: <a href="https://codepen.io/vpelss/pen/gOVqgeP" target="blank">https://codepen.io/vpelss/pen/gOVqgeP</a>, and <a href="https://github.com/vpelss/WhatAreTheOdds" target="blank">https://github.com/vpelss/WhatAreTheOdds</a></p>
<p>Inspiration from <a href="https://anydice.com/" target="blank">https://anydice.com/</a> and <a href="https://megadoug.com/dice-graph/" target="blank">https://megadoug.com/dice-graph/</a></p>
<p>This will allow a plot of the sums of R rolls with D dice that have S sides.</p>

<form>
  <label for="user_input">Input dice rolls:</label>
  <br>
  <textarea id="user_input" name="user_input" rows="6" cols="30" placeholder="eg: 4r5d6s means four rolls of 5 dice with six sides">
2000r1d2s 
2000r7d2s 
2000r1d6s 
2000r1d[1,2, 3, 4,5, 6]s 
2000r1d[1,2,2, 3, 4,5, 6]s 
2000r10d[1,2,2, 3, 4,5, 6]s 
</textarea>
  <p>One entry per line. 1000r10d6s means 1000 rolls of 10 dice with six sides. Dice can be loaded. eg: 1000r10d[1,2,3,4,5,6,6,6]s is a six sided die where a roll of 6 is three times more likely.</p>
  <label for="skip">Plot every:</label>
  <input type="number" id="skip" name="skip" min="0" max="5000" value="10">
  <p></p>
  <button type="button" id="runforest" value="1">Roll the bones</button>
</form>

<div id="plots"></div>

<script id="webworker" _type="javascript/worker">
  onmessage = function(event) {
    var input = event.data;
    Start_Worker(input);
  };

  function Start_Worker(input) {
    let lines = input.lines_toWebworker
    let skip = input.skip;
    let roll_arrays = [];
    let rolls = [];
    let dice = [];
    let sides_array = [];
    let roll_counts = [];
    let done;
    do { //for each roll
      done = 1; //assume we are done. prove otherwise.
      //for each line
      for (let ln = 0; ln < lines.length; ln++) {
        //test to see if all rolls have been completed
        if (typeof roll_counts[ln] == "undefined") { //create if required
          roll_counts[ln] = 0;
        }
        if (lines[ln].rolls > roll_counts[ln]) { //still not done
          roll_counts[ln]++;
          done = 0;
        } else { //this line is done
          continue;
        }
        //sum dice 
        let sum = 0;
        //let sum = 0;
        for (let d = 1; d <= lines[ln].dice; d++) { //# or dice to roll
          //randomly choose a die side 
          let side = Math.floor(Math.random() * lines[ln].sides_array.length);
          //what is its value?
          let value = lines[ln].sides_array[side];
          sum = sum + value;
        }
        //add to roll_arrays
        if (typeof roll_arrays[ln] == "undefined") { //create if required
          roll_arrays[ln] = [];
        }
        if (typeof roll_arrays[ln][sum] == "undefined") { //create if required
          roll_arrays[ln][sum] = 0;
        }
        //increase roll count by 1
        roll_arrays[ln][sum]++;
        if (roll_counts[ln] % skip == 0) {
          postMessage({
            "roll_counts": roll_counts,
            "roll_arrays": roll_arrays
          });
        }
      }
    }
    while (!done);
    //one more print!
    postMessage({
      "roll_counts": roll_counts,
      "roll_arrays": roll_arrays
    });
  }
</script>
  
      <script id="rendered-js" >
// 4r5d6s means roll 4 times with 5 dice of 6 sides
//1000r10d[1,2,3,4,5,6,6,6]s is a six sided die where a roll of 6 is three times more likely.
// we roll R times. For each roll we roll D dice and take the sum. We then increase the array position of that sum by one
//see: https://github.com/vpelss/WhatAreTheOdds

//set html events
let run_forest = document.getElementById("runforest");
run_forest.onclick = RunForestRun;

function Parse(text) {
  const re = /^(\d+)r(\d+)d(\d+|\[(?:\d+,)*\d+\])s/;
  //remove whitespace
  text = text.trim();
  text = text.replaceAll(" ", "");
  const found = text.match(re);
  if (found == null) {
    let msg = "Parse error in " + text;
    console.log(msg);
    return [null, null, null];
  }
  //build die
  let sides = RegExp.$3;
  let sides_array;
  // 3 to [1,2,3];
  if (!isNaN(sides)) {
    let numberme = Number(sides);
    sides_array = [...Array(numberme).keys()].map((x) => x + 1);
  } else {
    //sides shoud be [1,3,4,5,6]
    sides_array = JSON.parse(sides);
  }
  //sort side_array. no particular reason
  sides_array = sides_array.sort();
  return [RegExp.$1, RegExp.$2, sides_array];
}

//get inline webworker code.
var inline_webworker_blob = new Blob(
  [document.querySelector("#webworker").textContent],
  { type: "text/javascript" }
);

let webworker;
function RunForestRun() {
  document.getElementById("plots").innerHTML = ""; //clear plots if any
  skip = Number(document.getElementById("skip").value);
  let lines_text = document.getElementById("user_input").value;
  lines_text = lines_text.replaceAll(" ", ""); //space free
  //get lines
  lines = lines_text.split(/\r?\n/);
  lines = lines.filter((x) => x != ""); //remove blank lines
  let lines_toWebworker = [];
  let plotty_count = 0;
  for (let ln = 0; ln < lines.length; ln++) {
    //for each line
    let [rolls, dice, sides_array] = Parse(lines[ln]);
    if (rolls == null) {
      //line did not parse
      continue;
    }
    lines_toWebworker.push({
      rolls: rolls,
      dice: dice,
      sides_array: sides_array
    });
    //create a Ploty for line
    let div = document.createElement("div");
    div.style.width = "100%";
    div.id = "Ploty" + plotty_count;
    plotty_count++;
    document.getElementById("plots").appendChild(div);
  }
  if (webworker) {
    //if it is running, shut it down. Our human master has requested a new run
    webworker.terminate();
  }
  webworker = new Worker(window.URL.createObjectURL(inline_webworker_blob));
  //messages from webworker
  webworker.onmessage = function (event) {
    let output = event.data;
    roll_arrays = output.roll_arrays;
    roll_counts = output.roll_counts;
    for (let ln = 0; ln < roll_arrays.length; ln++) {
      //let count = lines[ln]["count"];
      //outcome_array = lines[ln]["outcome_array"];
      outcome_array = roll_arrays[ln];
      //graph them
      xArray = outcome_array.keys();
      const data = [
        {
          x: xArray,
          y: outcome_array,
          type: "bar"
        }
      ];
      const layout = {
        title: "Line " + (ln + 1) + " : " + roll_counts[ln] + " Dice Rolls Over"
      };
      Plotly.newPlot("Ploty" + ln, data, layout);
    }
  };
  //start webworker
  webworker.postMessage({ skip: skip, lines_toWebworker: lines_toWebworker });
}
    </script>

  
</body>

</html>
